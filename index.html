<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ultra-Low Fare · Victor Vega</title>

  <!-- Estilos existentes -->
  <link rel="stylesheet" href="style.css" />

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Chart.js para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* Pequeños retoques visuales (el resto lo toma de style.css) */
    header { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; background:#1e49b6; color:#fff; }
    header .title { font-weight:700; }
    header .sub { font-size:.85rem; opacity:.9 }
    nav { display:flex; gap:8px; padding:10px 16px; background:#f7f9fc; border-bottom:1px solid #e5edf7; }
    .btn { border:1px solid #d6e2ff; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .btn.active { background:#e9f1ff; border-color:#bcd1ff; }
    .actions { display:flex; gap:8px; align-items:center; margin-left:auto; }
    .primary { background:#1e49b6; color:#fff; border-color:#1e49b6; }
    main { padding:16px; }
    .muted { color:#777; font-size:.9rem; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border-bottom:1px solid #eee; padding:8px 10px; text-align:left; }
    .badge { padding:2px 8px; border-radius:999px; font-size:.8rem; }
    .ok { background:#eafaf0; color:#177245; border:1px solid #bfe6cc; }
    .bad { background:#fff2f2; color:#a12626; border:1px solid #f0c2c2; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .card { padding:14px; border:1px solid #e9eef9; border-radius:14px; background:#fff; }
    .card h4 { margin:0 0 6px }
    .right { text-align:right; }
    .tiny { font-size:.8rem; color:#666 }
    canvas { max-height:380px; }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">✈ Ultra-Low Fare · Victor Vega</div>
      <div class="sub">Actualizado automáticamente · Zona: <span id="tz">CST</span></div>
    </div>
    <div class="actions">
      <button id="btnRefresh" class="btn primary"><i class="fa-solid fa-rotate-right"></i> Actualizar</button>
    </div>
  </header>

  <nav>
    <button class="btn active" data-view="inicio"><i class="fa-regular fa-circle"></i> Resumen</button>
    <button class="btn" data-view="detalle" data-route="FLL"><i class="fa-solid fa-location-dot"></i> FLL</button>
    <button class="btn" data-view="detalle" data-route="MIA"><i class="fa-solid fa-location-dot"></i> MIA</button>
    <button class="btn" data-view="detalle" data-route="MCO"><i class="fa-solid fa-location-dot"></i> MCO</button>
    <button class="btn" data-view="historico"><i class="fa-solid fa-chart-line"></i> Histórico</button>
    <button class="btn" data-view="heatmap"><i class="fa-solid fa-fire"></i> Heatmap</button>
    <span class="muted" id="stamp" style="margin-left:auto"></span>
  </nav>

  <main id="app">
    <p class="muted">Cargando datos…</p>
  </main>

  <script>
    // ------- utilidades
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>[...ctx.querySelectorAll(sel)];
    const nowISO = ()=>new Date().toISOString();
    const CF = new Intl.NumberFormat('en-US',{style:'currency', currency:'USD'});

    // cache-busting para evitar caché en Vercel
    const fetchJSON = async (path)=> {
      const res = await fetch(${path}?t=${Date.now()}, {cache:'no-store'});
      if(!res.ok) throw new Error(HTTP ${res.status} al cargar ${path});
      return res.json();
    };

    // ------- estado
    let DATA = null;        // data.json
    let HIST = null;        // historico.json
    let heatChart = null;

    async function loadAll() {
      const [d, h] = await Promise.allSettled([
        fetchJSON('./data.json'),
        fetchJSON('./historico.json')
      ]);

      DATA = d.status === 'fulfilled' ? d.value : null;
      HIST = h.status === 'fulfilled' ? h.value : null;

      $('#stamp').textContent = DATA?.meta?.generado
        ? Generado: ${new Date(DATA.meta.generado).toLocaleString()}
        : 'Sin marca de tiempo';

      renderInicio();
    }

    // ------- renders
    function renderInicio() {
      setActive('inicio');
      const app = $('#app');
      if (!DATA?.resumen?.length) {
        app.innerHTML = <p class="muted">No hay datos en <code>data.json</code>.</p>;
        return;
      }

      const cards = DATA.resumen.map(r => {
        const ok = r.precio <= r.umbral;
        return `
          <div class="card">
            <h4>${r.ruta}</h4>
            <div class="tiny">Salida: <b>${r.salida}</b> · Retorno: <b>${r.retorno}</b></div>
            <div style="display:flex;justify-content:space-between;align-items:end;margin-top:8px">
              <div>
                <div>Precio más bajo: <b>${CF.format(r.precio)}</b></div>
                <div>Umbral: <b>${CF.format(r.umbral)}</b></div>
              </div>
              <span class="badge ${ok?'ok':'bad'}">${ok?'Cumple':'No cumple'}</span>
            </div>
          </div>
        `;
      }).join('');

      app.innerHTML = `
        <div class="cards">${cards}</div>
        <p class="tiny" style="margin-top:10px">Los precios son por pasajero, ida y vuelta, con impuestos/tasas.</p>
      `;
    }

    function renderDetalle(dest) {
      setActive('detalle', dest);
      const app = $('#app');

      // Busca la ruta en DATA
      const row = DATA?.resumen?.find(x => x.ruta.includes(dest));
      if (!row) {
        app.innerHTML = <p class="muted">No encontré datos para ${dest} en <code>data.json</code>.</p>;
        return;
      }

      const metaURLs = buildMetaURLs(dest, row.salida, row.retorno);
      const airlineURLs = buildAirlineURLs(dest, row.salida, row.retorno);

      app.innerHTML = `
        <div class="card">
          <h4>Resumen ${row.ruta}</h4>
          <div class="tiny">Salida: <b>${row.salida}</b> · Retorno: <b>${row.retorno}</b></div>
          <table>
            <tr><th>Precio más bajo</th><td>${CF.format(row.precio)}</td></tr>
            <tr><th>Umbral</th><td>${CF.format(row.umbral)}</td></tr>
            <tr><th>Resultado</th><td><span class="badge ${row.precio<=row.umbral?'ok':'bad'}">${row.precio<=row.umbral?'Cumple':'No cumple'}</span></td></tr>
          </table>
        </div>

        <div class="card">
          <h4><i class="fa-solid fa-magnifying-glass"></i> Abrir en metabuscadores</h4>
          <div class="cards">
            ${metaURLs.map(u => linkCard(u.name, u.url)).join('')}
          </div>
        </div>

        <div class="card">
          <h4><i class="fa-solid fa-plane-departure"></i> Ir directo a aerolíneas</h4>
          <div class="cards">
            ${airlineURLs.map(u => linkCard(u.name, u.url)).join('')}
          </div>
        </div>
      `;
    }

    function renderHistorico() {
      setActive('historico');
      const app = $('#app');

      if (!HIST?.historial?.length) {
        const msg = (!HIST) 
          ? 'No se pudo cargar <code>historico.json</code> (¿falta el archivo?).'
          : 'Aún no hay registros en el histórico.';
        app.innerHTML = <p class="muted">${msg}</p>;
        return;
      }

      // Tabla + gráfica (promedio por ruta)
      const rows = HIST.historial
        .slice() // copia
        .sort((a,b)=> new Date(b.meta.generado) - new Date(a.meta.generado))
        .map((h,i)=> {
          return `
            <tr>
              <td>${new Date(h.meta.generado).toLocaleString()}</td>
              <td>${h.ruta}</td>
              <td class="right">${CF.format(h.precio)}</td>
              <td class="right">${CF.format(h.umbral)}</td>
              <td class="right">${h.stops ?? '-'}</td>
              <td>${h.fuente ?? '-'}</td>
              <td><span class="badge ${h.precio<=h.umbral?'ok':'bad'}">${h.precio<=h.umbral?'Cumple':'No cumple'}</span></td>
            </tr>
          `;
        }).join('');

      // Datos para chart
      const byRoute = {};
      HIST.historial.forEach(h=>{
        byRoute[h.ruta] ??= [];
        byRoute[h.ruta].push(h.precio);
      });
      const labels = Object.keys(byRoute);
      const data = labels.map(k => Math.round(byRoute[k].reduce((a,b)=>a+b,0)/byRoute[k].length));

      app.innerHTML = `
        <div class="card">
          <h4><i class="fa-solid fa-table"></i> Histórico de simulaciones</h4>
          <table>
            <thead>
              <tr>
                <th>Fecha</th><th>Ruta</th><th class="right">Precio</th><th class="right">Umbral</th><th class="right">Escalas</th><th>Fuente</th><th>Resultado</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>

        <div class="card">
          <h4><i class="fa-solid fa-chart-column"></i> Promedio histórico por ruta</h4>
          <canvas id="histChart"></canvas>
        </div>
      `;

      // Render chart
      const ctx = $('#histChart');
      if (heatChart) { heatChart.destroy(); }
      heatChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'USD promedio', data }]
        },
        options: {
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    }

    function renderHeatmap() {
      setActive('heatmap');
      const app = $('#app');

      // Si no hay histórico, mostramos aviso
      if (!HIST?.historial?.length) {
        app.innerHTML = <p class="muted">Aún no hay suficiente histórico para el heatmap.</p>;
        return;
      }

      // Calcular frecuencia de “cumple” por ruta
      const tally = {};
      HIST.historial.forEach(h=>{
        tally[h.ruta] ??= { ok:0, total:0 };
        tally[h.ruta].total++;
        if (h.precio <= h.umbral) tally[h.ruta].ok++;
      });

      const labels = Object.keys(tally);
      const data = labels.map(k => Math.round(100 * tally[k].ok / tally[k].total));

      app.innerHTML = `
        <div class="card">
          <h4><i class="fa-solid fa-fire"></i> % de corridas que cumplieron umbral</h4>
          <canvas id="heatChart"></canvas>
          <p class="tiny">Mayor porcentaje = ruta más “caliente”.</p>
        </div>
      `;

      const ctx = $('#heatChart');
      if (heatChart) { heatChart.destroy(); }
      heatChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: '% que cumple', data }]
        },
        options: {
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{
            y:{ beginAtZero:true, max:100, ticks:{callback:(v)=>v+'%'} }
          }
        }
      });
    }

    // ------- helpers de links
    function linkCard(name, url) {
      return `
        <a class="card" href="${url}" target="_blank" rel="noopener">
          <h4 style="display:flex;align-items:center;gap:8px">
            <i class="fa-solid fa-up-right-from-square"></i> ${name}
          </h4>
          <div class="tiny">Abrir en nueva pestaña</div>
        </a>
      `;
    }

    function buildMetaURLs(dst, d1, d2) {
      // Metabuscadores (links parametrizados como usamos antes)
      const from = 'LIM';
      return [
        {
          name: 'Kayak',
          url: https://www.kayak.com/flights/${from}-${dst}/${d1}/${d2}?sort=bestflight_a&stops=1
        },
        {
          name: 'Skyscanner',
          url: https://www.skyscanner.com/transport/flights/${from.toLowerCase()}/${dst.toLowerCase()}/${d1.replaceAll('-','')}/${d2.replaceAll('-','')}/?adults=1&stops=1&cabinclass=economy
        },
        {
          name: 'Expedia',
          url: https://www.expedia.com/Flights-Search?trip=roundtrip&leg1=from:${from},to:${dst},departure:${d1}TANYT&leg2=from:${dst},to:${from},departure:${d2}TANYT&passengers=adults:1&options=cabinclass:economy&stops=1
        }
      ];
    }

    function buildAirlineURLs(dst, d1, d2) {
      const from = 'LIM';
      return [
        {
          name:'LATAM',
          url:https://www.latamairlines.com/pe/es/oferta-vuelos?origin=${from}&destination=${dst}&outbound=${d1}&inbound=${d2}&adt=1&cabin=economy
        },
        {
          name:'Avianca',
          url:https://www.avianca.com/en/?from=${from}&to=${dst}&departureDate=${d1}&returnDate=${d2}&adults=1&cabins=economy
        },
        {
          name:'Copa Airlines',
          url:https://book.copaair.com/booking/entry?tripType=roundtrip&origin=${from}&destination=${dst}&departureDate=${d1}&returnDate=${d2}&adults=1&cabin=economy
        },
        {
          name:'JetBlue',
          url:https://www.jetblue.com/book/flight?from=${from}&to=${dst}&depart=${d1}&return=${d2}&adult=1
        },
        {
          name:'American Airlines',
          url:https://www.aa.com/booking/find-flights?tripType=roundTrip&origin=${from}&destination=${dst}&departDate=${d1}&returnDate=${d2}&adult=1&cabin=coach
        },
        {
          name:'Spirit',
          url:https://www.spirit.com/booking?journey=RT&from=${from}&to=${dst}&depart=${d1}&return=${d2}&adult=1
        },
        {
          name:'United',
          url:https://www.united.com/en/us/fsr/choose-flights?f=${from}&t=${dst}&d=${d1}&r=${d2}&sc=7,0&px=1&c=ECONOMY
        },
        {
          name:'Delta',
          url:https://www.delta.com/flight-search/search?trip=RT&fromCity=LIM&toCity=${dst}&departureDate=${d1}&returnDate=${d2}&passengers=1&cabinClass=MAIN
        }
      ];
    }

    // ------- navegación
    function setActive(view, route) {
      $$('.btn').forEach(b => b.classList.remove('active'));
      if (view==='detalle') {
        $(.btn[data-view="detalle"][data-route="${route}"])?.classList.add('active');
      } else {
        $(.btn[data-view="${view}"])?.classList.add('active');
      }
    }

    // Eventos
    $('#btnRefresh').addEventListener('click', loadAll);

    $$('.btn[data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const view = btn.dataset.view;
        if (view==='inicio') return renderInicio();
        if (view==='historico') return renderHistorico();
        if (view==='heatmap') return renderHeatmap();
        if (view==='detalle') return renderDetalle(btn.dataset.route);
      });
    });

    // Go!
    loadAll().catch(err=>{
      $('#app').innerHTML = <p class="muted">Error cargando datos: ${err.message}</p>;
      console.error(err);
    });
  </script>
</body>
</html>
