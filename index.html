<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ultra-Low Fare · Víctor Vega</title>

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{--azul:#0d5bd7;--azul2:#003d9e;--ok:#1cb26b;--no:#e63b3b;--gris:#f5f7fb;--borde:#e5e9f2;--txt:#0f172a;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:var(--gris);color:var(--txt)}
header{background:linear-gradient(90deg,var(--azul),var(--azul2));color:#fff;padding:18px 16px}
h1{margin:0;font-size:20px;font-weight:700}
.sub{font-size:12px;opacity:.9}
.wrap{max-width:1100px;margin:18px auto;padding:0 12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.btn{padding:10px 12px;border-radius:10px;border:1px solid var(--borde);cursor:pointer;font-weight:600;background:#fff}
.btn.primary{background:var(--azul);color:#fff;border-color:var(--azul)}
.btn.ghost{background:transparent;color:#fff;border-color:#ffffff55}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{background:#fff;border:1px solid var(--borde);border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
.pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;font-size:12px;font-weight:700}
.ok{background:#eaf8f1;color:var(--ok);border:1px solid #c6efd9}
.no{background:#fdecec;color:var(--no);border:1px solid #f5b5b5}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px 12px;border-bottom:1px solid var(--borde);text-align:left;vertical-align:top}
thead{background:#eef4ff}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
.hidden{display:none}
canvas{max-width:100%}
.badge{display:inline-flex;gap:6px;align-items:center;background:#eef2ff;border:1px solid #dbe2ff;border-radius:8px;padding:4px 8px;font-size:12px}
.grid{overflow:auto;border:1px solid var(--borde);border-radius:12px;background:#fff}
.heat td,.heat th{border:1px solid #e5e9f2;text-align:center}
.small{font-size:12px;color:#64748b}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <i class="fa-solid fa-plane-departure"></i>
    <h1>Ultra-Low Fare · Víctor Vega</h1>
    <span class="sub" id="tz"></span>
    <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn ghost" id="refreshNow"><i class="fa-solid fa-rotate"></i> Actualizar</button>
      <button class="btn ghost" id="toggleAuto"><i class="fa-solid fa-clock"></i> Auto: <span id="autoState">off</span></button>
      <button class="btn ghost" id="btnCsv"><i class="fa-solid fa-file-csv"></i> CSV</button>
      <button class="btn ghost" id="btnPdf"><i class="fa-solid fa-file-pdf"></i> PDF</button>
      <a class="btn ghost" href="data.json" target="_blank"><i class="fa-solid fa-file-lines"></i> JSON</a>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="toolbar">
    <button class="btn primary" data-view="resumen"><i class="fa-solid fa-gauge-high"></i> Resumen</button>
    <button class="btn" data-view="detalle-fll"><i class="fa-solid fa-location-dot"></i> FLL</button>
    <button class="btn" data-view="detalle-mia"><i class="fa-solid fa-location-dot"></i> MIA</button>
    <button class="btn" data-view="detalle-mco"><i class="fa-solid fa-location-dot"></i> MCO</button>
    <button class="btn" data-view="historico"><i class="fa-solid fa-chart-line"></i> Histórico</button>
    <button class="btn" data-view="heatmap"><i class="fa-solid fa-border-all"></i> Heatmap</button>
  </div>

  <div id="stateBar" class="sub">Cargando datos…</div>

  <section id="view-resumen" class="view">
    <div class="cards" id="summary"></div>
  </section>

  <section id="view-detalle-fll" class="view hidden">
    <h2>LIM ⇄ FLL</h2>
    <div class="grid"><table id="tbl-fll"><thead>
      <tr><th>Proveedor</th><th>Tipo</th><th>Resultado</th><th>Estado</th><th>Acciones</th></tr>
    </thead><tbody></tbody></table></div>
  </section>

  <section id="view-detalle-mia" class="view hidden">
    <h2>LIM ⇄ MIA</h2>
    <div class="grid"><table id="tbl-mia"><thead>
      <tr><th>Proveedor</th><th>Tipo</th><th>Resultado</th><th>Estado</th><th>Acciones</th></tr>
    </thead><tbody></tbody></table></div>
  </section>

  <section id="view-detalle-mco" class="view hidden">
    <h2>LIM ⇄ MCO</h2>
    <div class="grid"><table id="tbl-mco"><thead>
      <tr><th>Proveedor</th><th>Tipo</th><th>Resultado</th><th>Estado</th><th>Acciones</th></tr>
    </thead><tbody></tbody></table></div>
  </section>

  <section id="view-historico" class="view hidden">
    <h2>Histórico (mínimos diarios por ruta)</h2>
    <div class="small" id="histNote"></div>
    <canvas id="chartHist" height="140"></canvas>
  </section>

  <section id="view-heatmap" class="view hidden">
    <h2>Heatmap ruta × fecha (últimos 30 días)</h2>
    <div class="small">Color según precio mínimo; celdas vacías = sin dato.</div>
    <div class="grid" style="margin-top:8px;overflow:auto">
      <table class="heat" id="tbl-heat" style="min-width:700px">
        <thead><tr id="heat-head"><th>Fecha</th><th>FLL</th><th>MIA</th><th>MCO</th></tr></thead>
        <tbody id="heat-body"></tbody>
      </table>
    </div>
  </section>

</div>

<script>
const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>[...r.querySelectorAll(s)];
const esc=s=>String(s).replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
const fmtUSD=v=>'$'+Number(v||0).toLocaleString('en-US',{maximumFractionDigits:0});
let DATA=null,AUTO=false,timer=null,chart=null;

$$('.toolbar .btn').forEach(b=>b.onclick=()=>{ $$('.toolbar .btn').forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); $$('.view').forEach(v=>v.classList.add('hidden')); $('#view-'+b.dataset.view).classList.remove('hidden'); });

$('#toggleAuto').onclick=()=>{AUTO=!AUTO;$('#autoState').textContent=AUTO?'on':'off';clearInterval(timer);if(AUTO)timer=setInterval(load,600000);}
$('#refreshNow').onclick=()=>load();
$('#btnCsv').onclick=exportCSV;
$('#btnPdf').onclick=exportPDF;

async function load(){
  const r=await fetch('data.json?ts='+Date.now());
  if(!r.ok){ $('#stateBar').textContent='No se pudo cargar data.json'; return;}
  DATA=await r.json();
  renderAll();
}

function renderAll(){
  const meta=DATA.meta||{};
  $('#tz').textContent='Zona: '+(meta.zona||'—');
  $('#stateBar').textContent='Última generación: '+(meta.generado||'—');

  renderSummary();
  renderDetalle('LIM ⇄ FLL','#tbl-fll');
  renderDetalle('LIM ⇄ MIA','#tbl-mia');
  renderDetalle('LIM ⇄ MCO','#tbl-mco');
  renderHistorico();
  renderHeatmap();
}

function renderSummary(){
  const wrap=$('#summary'); wrap.innerHTML='';
  (DATA.resumen||[]).forEach(r=>{
    const ok=/cumple/i.test(r.resultado||'');
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <h3><i class="fa-solid fa-route"></i> ${esc(r.ruta||'-')}</h3>
      <p><span class="pill ${ok?'ok':'no'}">${esc(r.resultado||'-')}</span></p>
      <p><span class="badge"><i class="fa-solid fa-dollar-sign"></i> Mín: ${fmtUSD(r.precio_mas_bajo_usd)}</span>
         <span class="badge"><i class="fa-solid fa-bullseye"></i> Umbral: ${fmtUSD(r.umbral_usd)}</span></p>
      <div class="row-actions">
        <button class="btn" data-go="${r.ruta.includes('FLL')?'detalle-fll':r.ruta.includes('MIA')?'detalle-mia':'detalle-mco'}"><i class="fa-solid fa-eye"></i> Ver detalle</button>
        ${r.best_url?<a class="btn" target="_blank" href="${esc(r.best_url)}"><i class="fa-solid fa-up-right-from-square"></i> Ver oferta</a>:''}
      </div>`;
    wrap.appendChild(card);
  });
  $$('#summary .btn[data-go]').forEach(b=>b.onclick=()=>{ $(.toolbar .btn[data-view="${b.dataset.go}"]).click(); });
}

function renderDetalle(key, tableSel){
  const det=DATA.detalles?.[key]; const tbody=$(${tableSel} tbody);
  if(!det){ tbody.innerHTML='<tr><td colspan="5">Sin datos.</td></tr>'; return;}
  tbody.innerHTML=(det.evaluaciones||[]).map(e=>`
    <tr>
      <td>${esc(e.fuente||'-')}</td>
      <td>${esc(e.tipo||'-')}</td>
      <td>${esc(e.resultado||'-')}</td>
      <td><span class="pill ${/cumple/i.test(e.estado)?'ok':'no'}">${esc(e.estado||'-')}</span></td>
      <td>
        <div class="row-actions">
          ${e.url?<a class="btn" target="_blank" href="${esc(e.url)}"><i class="fa-solid fa-up-right-from-square"></i> Ver oferta</a>:''}
          ${e.url?<button class="btn" onclick="navigator.clipboard.writeText('${e.url.replace(/'/g,"&#39;")}')"><i class="fa-solid fa-link"></i> Copiar</button>:''}
        </div>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="5">Sin resultados.</td></tr>';
}

function renderHistorico(){
  const hist = DATA.historico || []; // [{fecha:'YYYY-MM-DD', fll, mia, mco}]
  $('#histNote').textContent = Entradas: ${hist.length||0};
  const labels = hist.map(h=>h.fecha);
  const fll = hist.map(h=>h.fll ?? null);
  const mia = hist.map(h=>h.mia ?? null);
  const mco = hist.map(h=>h.mco ?? null);

  const sma = (arr, n=7)=>arr.map((_,i)=>{
    const slice=arr.slice(Math.max(0,i-n+1), i+1).filter(x=>typeof x==='number');
    if(!slice.length) return null;
    return Math.round(slice.reduce((a,b)=>a+b,0)/slice.length);
  });

  const datasets = [
    {label:'FLL', data:fll, borderColor:'#0d5bd7', tension:.2},
    {label:'MIA', data:mia, borderColor:'#18a957', tension:.2},
    {label:'MCO', data:mco, borderColor:'#e63b3b', tension:.2},
    {label:'Media 7 días (global)', data:sma(hist.map(h=>Math.min(...[h.fll,h.mia,h.mco].filter(x=>typeof x==='number')))), borderDash:[5,5], borderColor:'#555', tension:.2}
  ].map(d=>({...d, spanGaps:true, fill:false}));

  const ctx = $('#chartHist');
  if(chart) chart.destroy();
  chart = new Chart(ctx,{type:'line',data:{labels,datasets},options:{plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:false}}}});
}

function renderHeatmap(){
  const hist = (DATA.historico||[]).slice(-30); // últimos 30
  const body = $('#heat-body'); body.innerHTML='';
  if(!hist.length){ body.innerHTML='<tr><td colspan="4">Sin datos.</td></tr>'; return; }
  const flat = hist.flatMap(h=>[h.fll,h.mia,h.mco].filter(x=>typeof x==='number'));
  const min = Math.min(...flat), max = Math.max(...flat);
  const color = v=>{
    if(v==null) return '#fff';
    const t = (v-min)/Math.max(1,(max-min));
    const r = Math.round(255*(t)), g = Math.round(255*(1-t));
    return rgb(${r},${g},140);
  };
  hist.forEach(h=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="small">${esc(h.fecha)}</td>
      <td style="background:${color(h.fll)}">${h.fll?fmtUSD(h.fll):''}</td>
      <td style="background:${color(h.mia)}">${h.mia?fmtUSD(h.mia):''}</td>
      <td style="background:${color(h.mco)}">${h.mco?fmtUSD(h.mco):''}</td>
    `;
    body.appendChild(tr);
  });
}

function exportCSV(){
  const rows = [];
  (DATA.resumen||[]).forEach(r=>{
    rows.push([r.ruta, r.resultado, r.precio_mas_bajo_usd, r.umbral_usd, r.ultima_ejecucion||'']);
  });
  const csv = 'Ruta,Resultado,Min USD,Umbral USD,Última ejecución\n' + rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='resumen.csv'; a.click();
}

async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14); doc.text('Ultra-Low Fare · Resumen', 14, 16);
  let y=26;
  (DATA.resumen||[]).forEach(r=>{
    doc.setFontSize(11);
    doc.text(${r.ruta} — ${r.resultado} — Min: ${r.precio_mas_bajo_usd} — Umbral: ${r.umbral_usd}, 14, y);
    y+=7; if(y>280){ doc.addPage(); y=20; }
  });
  doc.save('resumen.pdf');
}

load();
</script>
</body>
</html>
