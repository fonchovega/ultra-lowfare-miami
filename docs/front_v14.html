<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ultra-LowFare v1.3.2 — Reporteador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Estilos mínimos “tipo metabuscador” -->
  <style>
    :root{
      --bg:#0c0f12; --card:#12161b; --muted:#9fb0c0; --text:#e9f1f5; --accent:#29b6f6; --ok:#1ec28a; --warn:#f7b733; --bad:#f45d48;
      --chip:#1b222a; --chip2:#1f2832;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:18px 20px;border-bottom:1px solid #212a33;background:linear-gradient(180deg,#0c0f12 0,#0c0f12ee 100%)}
    h1{margin:0;font-size:18px;display:flex;gap:10px;align-items:center}
    .meta{font-size:12px;color:var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .controls{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:8px 0 16px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls input,.controls select{width:100%;padding:8px 10px;border:1px solid #2a3440;background:#0f1318;color:var(--text);border-radius:10px}
    .tabs{display:flex;gap:8px;margin:8px 0 16px}
    .tab{padding:10px 14px;border-radius:999px;background:var(--chip);cursor:pointer;color:#cfe6f7;border:1px solid #233041}
    .tab.active{background:var(--accent);color:#032436;border-color:transparent}
    .card{background:var(--card);border:1px solid #222b35;border-radius:16px;padding:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px dashed #233041;vertical-align:top}
    th{font-weight:600;text-align:left;color:#cfe6f7;white-space:nowrap}
    tr:hover td{background:#0f141a}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:8px 0 16px}
    .kpi{background:var(--card);border:1px solid #223040;border-radius:14px;padding:14px}
    .kpi h3{margin:0 0 4px;font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--chip2);border:1px solid #2a3746;color:#cfe6f7;font-size:12px}
    .chip.ok{background:#07251b;border-color:#0d3b29;color:#b7f2d8}
    .chip.bad{background:#2b1412;border-color:#3a1916;color:#ffcdc6}
    .chip.tag{background:#17202a;border-color:#1c2833}
    .rowchips{display:flex;flex-wrap:wrap;gap:6px}
    .hint{color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .foot{margin-top:10px;font-size:12px;color:var(--muted)}
    .calendar-hint{font-size:12px;color:var(--muted)}
    .badge{padding:2px 6px;border-radius:6px;background:#1b2733;border:1px solid #243345;font-size:12px}
    .live{background:#0e2d20;border-color:#124a34;color:#a9f2d3}
    .mock{background:#302016;border-color:#4a2d1a;color:#ffd6bf}
    .nowrap{white-space:nowrap}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Ultra-LowFare — Reporteador v1.3.2
        <span class="badge" id="modeBadge">–</span>
      </h1>
      <div class="meta" id="metaLine">Cargando datasets…</div>
    </div>
  </header>

  <div class="wrap">
    <!-- Filtros -->
    <div class="card">
      <div class="controls">
        <div>
          <label>Desde (fecha de salida)</label>
          <input type="date" id="fromDate"/>
          <div class="calendar-hint" id="fromHint"></div>
        </div>
        <div>
          <label>Hasta (fecha de salida)</label>
          <input type="date" id="toDate"/>
          <div class="calendar-hint" id="toHint"></div>
        </div>
        <div>
          <label>Ruta</label>
          <select id="routeSel"><option value="">Todas</option></select>
        </div>
        <div>
          <label>Modo</label>
          <select id="modeSel">
            <option value="">Live + Mock</option>
            <option value="live">Solo Live</option>
            <option value="mock">Solo Mock</option>
          </select>
        </div>
        <div>
          <label>Carry-on requerido</label>
          <select id="carrySel">
            <option value="">Cualquiera</option>
            <option value="true">Sí</option>
            <option value="false">No/Indef.</option>
          </select>
        </div>
        <div class="right">
          <button id="applyBtn" class="tab">Aplicar filtros</button>
          <button id="clearBtn" class="tab">Limpiar</button>
        </div>
      </div>
      <div class="hint">Las fechas resaltadas en el hint indican días con datos disponibles.</div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><h3>Snapshots histórico</h3><div class="v" id="kpiHist">–</div></div>
      <div class="kpi"><h3>Mejor total (último snapshot)</h3><div class="v" id="kpiBest">–</div></div>
      <div class="kpi"><h3>Resultados (filtrados)</h3><div class="v" id="kpiCount">–</div></div>
      <div class="kpi"><h3>Última generación</h3><div class="v" id="kpiGen">–</div></div>
    </div>

    <!-- Pestañas -->
    <div class="tabs">
      <div class="tab active" data-tab="best">Mejor opción</div>
      <div class="tab" data-tab="history">Historial</div>
      <div class="tab" data-tab="all">Todas las búsquedas</div>
    </div>

    <!-- Contenido pestañas -->
    <div id="tab-best" class="card">
      <table id="bestTable">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Ruta</th>
            <th>Total USD</th>
            <th>Vuelo USD</th>
            <th>Terrestre</th>
            <th>Proveedor</th>
            <th>Equipaje</th>
            <th>Modo</th>
            <th>Restricciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="foot">Se muestra la mejor fila por ruta según filtros.</div>
    </div>

    <div id="tab-history" class="card hidden">
      <canvas id="chart" height="120"></canvas>
      <div class="foot">Histórico del mejor total por ruta (por snapshot).</div>
    </div>

    <div id="tab-all" class="card hidden">
      <table id="allTable">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Ruta</th>
            <th>Total USD</th>
            <th>Vuelo USD</th>
            <th>Terrestre</th>
            <th>Proveedor</th>
            <th>Equipaje</th>
            <th>Modo</th>
            <th>Restricciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="foot">Todas las filas del último snapshot que cumplen filtros.</div>
    </div>
  </div>

  <script>
    // ------- Carga de datasets -------
    const paths = {
      snap: "../data/data.json",
      hist: "../data/historico.json",
      bagg: "../data/baggage_policies.json"
    };

    const state = {
      snapshot: null,
      historico: [],
      baggage: null,
      chart: null,
      daysWithData: new Set()
    };

    function $(q){return document.querySelector(q)}
    function el(tag,cls){const n=document.createElement(tag); if(cls) n.className=cls; return n}

    async function safeFetchJSON(url){
      try{ const r = await fetch(url, {cache:"no-store"}); if(!r.ok) throw new Error(r.status); return await r.json(); }
      catch{ return null; }
    }

    function fmtMoney(n){ return (typeof n==="number" && isFinite(n)) ? n.toFixed(2) : "–"; }
    function fmtDateTime(iso){
      if(!iso) return "–";
      const d = new Date(iso);
      if(Number.isNaN(+d)) return iso;
      const dd = d.toISOString().slice(0,10);
      const hh = d.toISOString().slice(11,16);
      return `${dd} ${hh}`;
    }

    // Heurística simple para extraer un id de aerolínea desde provider (si viene texto)
    function guessProviderId(provider){
      if(!provider) return null;
      const p = provider.toLowerCase();
      // atajos comunes
      if(p.includes("american")) return "aa";
      if(p.includes("delta")) return "dl";
      if(p.includes("united")) return "ua";
      if(p.includes("jetblue")) return "b6";
      if(p.includes("latam")) return "la";
      if(p.includes("avianca")) return "av";
      if(p.includes("spirit")) return "nk";
      if(p.includes("frontier")) return "f9";
      if(p.includes("copa")) return "cm";
      if(p.includes("sky")) return "sky";
      if(p.includes("jetsmart")) return "jb";
      // metasearch
      if(p.includes("google")) return "googleflights";
      if(p.includes("skyscanner")) return "skyscanner";
      if(p.includes("kayak")) return "kayak";
      if(p.includes("momondo")) return "momondo";
      return null;
    }

    function baggageLabel(policy){
      if(!policy) return "–";
      const carry = policy.carry_on_included===true ? "✔ carry-on" :
                    policy.carry_on_included===false ? "✖ carry-on" : "carry-on: n/d";
      let bag = "maleta: n/d";
      if(typeof policy.checked_bag_first_usd==="number") bag = `1ª maleta: $${policy.checked_bag_first_usd}`;
      if(typeof policy.checked_bag_base_usd==="string") bag = `maleta: ${policy.checked_bag_base_usd}`;
      return `${policy.source || "Política"} · ${carry} · ${bag}`;
    }

    function policyFor(row){
      const id = guessProviderId(row.provider);
      if(!id || !state.baggage) return null;
      // región aproximada según ruta
      const dest = (row.route || "").split("-")[1] || "";
      // heuristic: si llega a MCO/FLL/MIA desde LIM => latam_usa
      const region = ["MIA","FLL","MCO"].includes(dest) ? "latam_usa" : "any";
      // buscar
      const air = (state.baggage.airlines || []).find(a=>a.id===id);
      if(air){
        return air.regions?.[region] || air.regions?.["any"] || { source: air.name };
      }
      const meta = (state.baggage.metasearch || []).find(m=>m.id===id);
      if(meta){ return { source: meta.name, ...meta.policy }; }
      return state.baggage.defaults?.unknown_airline || null;
    }

    function constraintChips(row){
      const wrap = el("div","rowchips");
      const c = row.meta?.constraints || {};
      const carry = c.carry_on_only===true ? el("span","chip ok") : el("span","chip");
      carry.textContent = c.carry_on_only===true ? "carry-on requerido" : "carry-on: libre";
      const stops = el("span","chip");
      stops.textContent = `máx escalas: ${c.max_stops ?? "n/d"}`;
      wrap.append(carry,stops);
      return wrap;
    }

    function terrestrialCol(row){
      const t = [];
      if(typeof row.terrestre_cost_usd==="number" && row.terrestre_cost_usd>0){
        t.push(`$${fmtMoney(row.terrestre_cost_usd)}`);
      } else {
        t.push("—");
      }
      if(row.terrestre_tipo) t.push(`${row.terrestre_tipo} · ${row.terrestre_label || ""}`.trim());
      return t.join(" ");
    }

    function modeBadge(mode){
      const s = el("span","badge "+(mode==="live"?"live":"mock"));
      s.textContent = mode==="live" ? "LIVE" : "MOCK";
      return s;
    }

    function buildRoutesFromSnapshot(snap){
      const set = new Set((snap?.resultados||[]).map(r=>r.route).filter(Boolean));
      return Array.from(set.values());
    }

    function collectDaysWithData(hist){
      const set = new Set();
      (hist||[]).forEach(s => {
        const d = (s.meta?.generado||"").slice(0,10);
        if(d) set.add(d);
      });
      return set;
    }

    function updateCalendarHints(){
      const arr = Array.from(state.daysWithData).sort();
      $("#fromHint").textContent = arr.length ? `Días con data: ${arr.join(", ")}` : "Sin marcas";
      $("#toHint").textContent = $("#fromHint").textContent;
    }

    function applyFilters(rows){
      const route = $("#routeSel").value || "";
      const mode  = $("#modeSel").value || "";
      const cary  = $("#carrySel").value || "";

      const from = $("#fromDate").value || "";
      const to   = $("#toDate").value || "";

      return (rows||[]).filter(r=>{
        if(route && r.route!==route) return false;
        if(mode && (r.meta?.mode||"")!==mode) return false;
        if(cary==="true"  && r.meta?.constraints?.carry_on_only!==true) return false;
        if(cary==="false" && r.meta?.constraints?.carry_on_only===true) return false;
        const d = r.depart_date || r.dep || "";
        if(from && d<from) return false;
        if(to   && d>to) return false;
        return true;
      });
    }

    function bestByRoute(rows){
      const map = new Map();
      for(const r of rows){
        const key = r.route;
        if(!key) continue;
        const tot = (typeof r.total_usd==="number") ? r.total_usd :
                    (typeof r.aereo==="number") ? r.aereo : Number.POSITIVE_INFINITY;
        if(!map.has(key) || tot < map.get(key).total) map.set(key, { row:r, total:tot });
      }
      return Array.from(map.values()).map(x=>x.row);
    }

    function fillTable(tbody, rows){
      tbody.innerHTML = "";
      for(const r of rows){
        const tr = el("tr");

        const dt = el("td");
        dt.innerHTML = `<div class="nowrap">${r.depart_date||r.dep||"—"} ${r.depart_time||"—"}</div><div class="muted">${fmtDateTime(r.meta?.generated)}</div>`;

        const route = el("td"); route.textContent = r.route || "—";

        const total = el("td"); total.innerHTML = `<span class="chip ok">$${fmtMoney(r.total_usd)}</span>`;

        const aereo = el("td"); aereo.textContent = fmtMoney(r.aereo);

        const terr = el("td"); terr.textContent = terrestrialCol(r);

        const prov = el("td");
        const p = el("div","flex");
        const m = modeBadge(r.meta?.mode||"mock");
        const pv = el("span",""); pv.textContent = r.provider || "—";
        p.append(m,pv);
        prov.appendChild(p);

        const bag = el("td");
        const pol = policyFor(r);
        bag.textContent = baggageLabel(pol);

        const modec = el("td");
        modec.appendChild(modeBadge(r.meta?.mode||"mock"));

        const cons = el("td");
        cons.appendChild(constraintChips(r));

        [dt,route,total,aereo,terr,prov,bag,modec,cons].forEach(td=>tr.appendChild(td));
        tbody.appendChild(tr);
      }
    }

    function updateKpis(rows){
      $("#kpiCount").textContent = rows.length.toString();
      const best = rows.reduce((acc,r)=>{
        const v = (typeof r.total_usd==="number") ? r.total_usd : (typeof r.aereo==="number" ? r.aereo : Infinity);
        return v<acc ? v : acc;
      }, Infinity);
      $("#kpiBest").textContent = isFinite(best) ? `$${best.toFixed(2)}` : "–";
    }

    function buildChart(){
      const ctx = $("#chart").getContext("2d");
      if(state.chart){ state.chart.destroy(); state.chart = null; }
      // Serie: por ruta, mejor total por snapshot
      const byRoute = new Map();
      (state.historico||[]).forEach(snap=>{
        const ts = snap.meta?.generado;
        const best = {};
        (snap.resultados||[]).forEach(r=>{
          const key = r.route;
          const tot = (typeof r.total_usd==="number") ? r.total_usd :
                      (typeof r.aereo==="number") ? r.aereo : Infinity;
          if(!best[key] || tot < best[key]) best[key] = tot;
        });
        Object.entries(best).forEach(([route,val])=>{
          if(!byRoute.has(route)) byRoute.set(route, []);
          byRoute.get(route).push({x: ts, y: val});
        });
      });

      const datasets = Array.from(byRoute.entries()).map(([route,points])=>({
        label: route, data: points, tension: 0.2
      }));

      state.chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'day' } },
            y: { title: { display: true, text: 'USD' }, beginAtZero: false }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: { label: (c)=> `${c.dataset.label}: $${fmtMoney(c.parsed.y)} (${c.parsed.x})` }
            }
          }
        }
      });
    }

    function populateFilters(){
      // Rutas
      const routes = buildRoutesFromSnapshot(state.snapshot);
      const sel = $("#routeSel");
      sel.innerHTML = `<option value="">Todas</option>` + routes.map(r=>`<option>${r}</option>`).join("");
      // Días con data (hint)
      state.daysWithData = collectDaysWithData(state.historico);
      updateCalendarHints();
      // KPI gen
      $("#kpiHist").textContent = (state.historico||[]).length.toString();
      $("#kpiGen").textContent = state.snapshot?.meta?.generado ? fmtDateTime(state.snapshot.meta.generado) : "–";
      // Modo
      const mode = (state.snapshot?.meta?.mode || "mock").toUpperCase();
      const badge = $("#modeBadge");
      badge.textContent = mode;
      badge.className = "badge " + ((mode==="LIVE") ? "live" : "mock");
      $("#metaLine").textContent = `Proyecto: ${state.snapshot?.meta?.project || "—"} · v${state.snapshot?.meta?.v || "1.3.x"} · ${routes.length} rutas en snapshot`;
    }

    function refreshTables(){
      const rows = applyFilters(state.snapshot?.resultados||[]);
      // Best table
      const best = bestByRoute(rows);
      fillTable($("#bestTable tbody"), best);
      // All table
      fillTable($("#allTable tbody"), rows);
      updateKpis(rows);
    }

    async function boot(){
      const [snap,hist,bagg] = await Promise.all([
        safeFetchJSON(paths.snap),
        safeFetchJSON(paths.hist),
        safeFetchJSON(paths.bagg)
      ]);
      state.snapshot = snap || { resultados:[], meta:{} };
      state.historico = Array.isArray(hist) ? hist : (hist ? [hist] : []);
      state.baggage = bagg;

      populateFilters();
      refreshTables();
      buildChart();

      // Eventos UI
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=>{
          document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
          t.classList.add("active");
          const target = t.dataset.tab;
          ["best","history","all"].forEach(id=>{
            $("#tab-"+id).classList.toggle("hidden", id!==target);
          });
          if(target==="history") buildChart();
        });
      });

      $("#applyBtn").onclick = ()=> refreshTables();
      $("#clearBtn").onclick = ()=>{
        $("#fromDate").value = "";
        $("#toDate").value = "";
        $("#routeSel").value = "";
        $("#modeSel").value = "";
        $("#carrySel").value = "";
        refreshTables();
      };
    }

    // Espera a que cargue Chart.js si hay red lenta
    window.addEventListener("load", boot);
  </script>
</body>
</html>
