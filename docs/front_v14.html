<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ultra-LowFare ¬∑ FrontWeb UX v1.4 (Full DB Viewer ¬∑ RAW)</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101821; --card:#0f172a; --ink:#e2e8f0;
      --muted:#94a3b8; --brand:#7cd4ff; --ok:#2bdc8c; --bad:#ff6b6b; --line:#1f2937;
      --accent:#eab308;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.5 system-ui, Segoe UI, Roboto, Arial; color:var(--ink); background:linear-gradient(180deg,#0c1118,#0b0f14)}
    header{display:flex;gap:14px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0c1420,#0c1118)}
    header h1{margin:0;font-size:18px}
    .badge{padding:4px 10px;border:1px solid #2a3a4d;border-radius:99px;color:#9fb3c8;background:#0f1520}
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100vh - 60px)}
    aside{background:var(--panel);border-right:1px solid var(--line);padding:14px}
    aside h3{margin:10px 0 6px;font-size:13px;color:#a8c1d8}
    aside label{display:block;font-size:13px;color:#cbd5e1;margin:8px 0}
    aside input, aside select{width:100%;background:#0f1520;color:#e2e8f0;border:1px solid #2a3a4d;border-radius:8px;padding:8px}
    aside .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    aside .btn{width:100%;margin-top:10px;padding:9px 10px;background:#102033;border:1px solid #25405c;border-radius:10px;color:#bfe3ff;cursor:pointer}
    aside .btn:hover{background:#0f2036}
    .main{display:grid;grid-template-rows:160px 1fr;gap:12px;padding:14px}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    .kpi-title{color:#9fb3c8;font-size:12px}
    .kpi-value{font-size:28px;font-weight:700;margin-top:6px}
    .tabs{display:flex;gap:8px;padding:8px;flex-wrap:wrap}
    .tab{padding:7px 10px;border:1px solid #2a3a4d;border-radius:10px;background:#0f1520;color:#cbd5e1;cursor:pointer}
    .tab.active{background:#193652;border-color:#2b5b86;color:#cfe9ff}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .panel header{position:static;background:var(--card);border-bottom:1px solid var(--line);padding:10px 12px}
    .panel .content{padding:0}
    .table-wrap{overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #0f1924;white-space:nowrap}
    th{background:#0f1924;position:sticky;top:0}
    tr:hover td{background:#0e1522}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #2a3a4d;background:#0f1520;color:#bcd1e3;font-size:12px}
    .mininote{font-size:12px;color:#93acc4}
    .status-ok{color:var(--ok)} .status-bad{color:var(--bad)}
    .route-tag{padding:2px 8px;border-radius:8px;background:#0f1928;border:1px solid #26445f;color:#9fd1ff}
    .muted{color:var(--muted)}
    .flex{display:flex;align-items:center;gap:10px}
    .space{flex:1}
    .note{font-size:12px;color:#93acc4;margin-top:8px}
    svg{display:block;width:100%;height:260px;background:#0b111a}
    .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:#9fb3c8;padding:6px 10px}
    .tag{padding:2px 8px;border-radius:8px;background:#0f1928;border:1px solid #26445f}
    .btn-sec{padding:6px 10px;border-radius:8px;border:1px solid #2a3a4d;background:#0f1520;color:#cfe9ff;cursor:pointer}
    .btn-sec:hover{background:#11223a}
  </style>
</head>
<body>
  <header>
    <h1>Ultra-LowFare ¬∑ FrontWeb UX v1.4</h1>
    <span class="badge">Dataset: <b>data.json</b> + <b>historico.json</b> (RAW)</span>
    <span class="badge">Compat: v1.1 ‚Üí v1.3.2</span>
    <span class="badge">Rutas LIM‚ÜîMIA/FLL/MCO</span>
    <div class="space"></div>
    <span class="mininote">Sin duplicados: lectura directa desde /data del repo (raw.githubusercontent.com)</span>
  </header>

  <section class="layout">
    <aside>
      <h3>Rutas</h3>
      <select id="routeSel"></select>

      <h3>Rango de fechas (hist√≥rico)</h3>
      <div class="row">
        <input id="dateFrom" type="date">
        <input id="dateTo" type="date">
      </div>

      <h3>Preferencias</h3>
      <label><input id="prefCarry" type="checkbox" checked> Solo carry-on</label>
      <label><input id="prefStops" type="checkbox" checked> M√°x 1 escala</label>

      <button class="btn" id="btnReload">üîÑ Actualizar datos</button>
      <div class="note">
        ‚Ä¢ ‚ÄúMejor opci√≥n‚Äù = <b>precio a√©reo m√°s bajo</b> + terrestre aplicable.<br>
        ‚Ä¢ <b>LIM‚ÜíMCO</b>: fuerza alquiler de auto (regla).<br>
        ‚Ä¢ <b>LIM‚ÜíMIA/FLL</b>: intenta tren; si no hay, cae a auto.
      </div>
    </aside>

    <main class="main">
      <div class="kpis">
        <div class="card">
          <div class="kpi-title">Mejor total (a√©reo+terrestre)</div>
          <div class="kpi-value" id="kpiBestTotal">‚Äî</div>
          <div class="mininote" id="kpiBestTotalDetail">‚Äî</div>
        </div>
        <div class="card">
          <div class="kpi-title">Mejor a√©reo</div>
          <div class="kpi-value" id="kpiBestAir">‚Äî</div>
          <div class="mininote" id="kpiBestAirDetail">‚Äî</div>
        </div>
        <div class="card">
          <div class="kpi-title">Promedio hist√≥rico</div>
          <div class="kpi-value" id="kpiAvg">‚Äî</div>
          <div class="mininote" id="kpiAvgDetail">‚Äî</div>
        </div>
        <div class="card">
          <div class="kpi-title">Snapshots analizados</div>
          <div class="kpi-value" id="kpiSnaps">0</div>
          <div class="mininote" id="kpiSnapsDetail">Ventana temporal seleccionada</div>
        </div>
        <div class="card">
          <div class="kpi-title">Proveedor top (frecuencia)</div>
          <div class="kpi-value" id="kpiTopProv">‚Äî</div>
          <div class="mininote" id="kpiTopProvDetail">M√°s veces ‚Äúmejor precio‚Äù</div>
        </div>
      </div>

      <div class="panel">
        <header class="flex">
          <div class="tabs">
            <button class="tab active" data-tab="t1">1) Mejor opci√≥n por d√≠a/hora</button>
            <button class="tab" data-tab="t2">2) Hist√≥rico m√≠nimo por d√≠a/hora</button>
            <button class="tab" data-tab="t3">3) Detalle completo por d√≠a/hora</button>
            <button class="tab" data-tab="t4">4) Explorador completo (sin filtros)</button>
          </div>
          <div class="space"></div>
          <span class="route-tag" id="routeBadge">‚Äî</span>
        </header>

        <!-- TAB 1 -->
        <div class="content" id="viewT1">
          <div class="table-wrap">
            <table id="tblBest">
              <thead>
                <tr>
                  <th>Fecha salida</th>
                  <th>Hora salida</th>
                  <th>A√©reo (USD)</th>
                  <th>Proveedor</th>
                  <th>Terrestre</th>
                  <th>Costo terrestre (USD)</th>
                  <th>Total (USD)</th>
                  <th>Detalle</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- TAB 2 -->
        <div class="content" id="viewT2" style="display:none">
          <div class="legend">
            <span class="tag">Serie: m√≠nimo diario (a√©reo)</span>
            <span class="muted" id="chartMeta">‚Äî</span>
          </div>
          <svg id="chart"></svg>
        </div>

        <!-- TAB 3 -->
        <div class="content" id="viewT3" style="display:none">
          <div class="table-wrap">
            <table id="tblFull">
              <thead>
                <tr>
                  <th>Fecha/hora</th>
                  <th>Ruta</th>
                  <th>A√©reo (USD)</th>
                  <th>Cumple l√≠mite</th>
                  <th>L√≠mite</th>
                  <th>Fuente/Proveedor</th>
                  <th>Equipaje</th>
                  <th>Escalas</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- TAB 4: Explorador completo -->
        <div class="content" id="viewT4" style="display:none">
          <div class="flex" style="padding:10px 12px;border-bottom:1px solid #0f1924;background:#0f1924">
            <div class="mininote">Explora absolutamente todos los registros tal como existen en los JSON (sin filtros de carry/escala).</div>
            <div class="space"></div>
            <button id="btnCSV" class="btn-sec">‚¨áÔ∏è Exportar CSV (todos)</button>
          </div>
          <div class="table-wrap">
            <table id="tblExplorer">
              <thead>
                <tr>
                  <th>Snapshot TS</th>
                  <th>Ruta</th>
                  <th>A√©reo (USD)</th>
                  <th>Under budget</th>
                  <th>L√≠mite</th>
                  <th>Proveedor</th>
                  <th>Equipaje</th>
                  <th>Escalas</th>
                  <th>Modo origen</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </main>
  </section>

<script>
/* ========= 0) Rutas RAW (sin duplicar data) ========= */
const RAW_BASE = "https://raw.githubusercontent.com/fonchovega/ultra-lowfare-miami/main";
const PATH_DATA = `${RAW_BASE}/data/data.json`;
const PATH_HIST = `${RAW_BASE}/data/historico.json`;

/* ========= Reglas terrestres (placeholder) ========= */
function terrestrialRule(route){
  const r = route.replace(/\s/g,'').toUpperCase();
  if(r.includes("LIM") && r.includes("MCO")){
    return { mode:"auto", cost: 45 };
  }
  if(r.includes("LIM") && (r.includes("MIA") || r.includes("FLL"))){
    return { mode:"tren", cost: 18 };
  }
  return { mode:"n/a", cost: 0 };
}

/* ========= Utilidades ========= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtUSD = v => (v==null || isNaN(v)) ? "‚Äî" : "$" + Number(v).toFixed(0);
function csvEscape(v){ if (v==null) return ""; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; }

/* ========= Normalizaci√≥n (mock viejo y live nuevo) ========= */
function normalizeFromSnapshot(snapshot){
  const out = [];
  const rawRows = [];
  const ts = snapshot?.meta?.generado || snapshot?.meta?.timestamp || snapshot?.fecha || new Date().toISOString();
  const list = snapshot?.resultados || snapshot?.resultado || [];
  for (const r of list){
    rawRows.push({ ts, r });

    if ('precio_encontrado' in r){ // MOCK
      const iso = r.fecha || ts;
      out.push({
        ts,
        date: iso.slice(0,10),
        time: iso.slice(11,16),
        route: (r.ruta || "").replace(/\s+/g,''),
        air: +r.precio_encontrado || null,
        ok: String(r.cumple||'').includes('S√≠'),
        limit: r.limite ?? null,
        provider: r.fuente || 'mock',
        equip: r.detalles?.equipaje ?? '',
        stops: r.detalles?.escalas_max ?? null,
        origin_mode: "mock"
      });
      continue;
    }
    if (r.best_offer){ // LIVE
      const prov = [...(r.providers?.meta||[]),(r.providers?.airlines||[])].flat();
      const bestProv = prov.sort((a,b)=>(b.score??0)-(a.score??0))[0];
      const iso = r.dep || ts;
      out.push({
        ts,
        date: iso.slice(0,10),
        time: iso.slice(11,16),
        route: (r.route||"").replace(/\s+/g,''),
        air: +r.best_offer.total_usd || null,
        ok: !!r.best_offer.under_budget,
        limit: null,
        provider: bestProv?.name || bestProv?.id || 'live',
        equip: (r.constraints?.carry_on_required ? "carry-on" : ''),
        stops: r.constraints?.max_stops ?? null,
        origin_mode: "live"
      });
      continue;
    }
  }
  return { rows: out, rawRows };
}

/* ========= Carga dataset (RAW) ========= */
async function loadDataset(){
  const bust = `?t=${Date.now()}`;
  const [hist, snap] = await Promise.all([
    fetch(PATH_HIST + bust).then(r=>r.json()).catch(()=>[]),
    fetch(PATH_DATA + bust).then(r=>r.json()).catch(()=>null)
  ]);

  const rows = [];
  const raw = [];

  if (Array.isArray(hist)){
    for (const s of hist){
      const {rows: rr, rawRows} = normalizeFromSnapshot(s);
      rows.push(...rr); raw.push(...rawRows);
    }
  }
  if (snap && snap.resultados){
    const {rows: rr, rawRows} = normalizeFromSnapshot(snap);
    rows.push(...rr); raw.push(...rawRows);
  }

  rows.sort((a,b)=> a.ts.localeCompare(b.ts));
  const routes = Array.from(new Set(rows.map(x=>x.route))).filter(Boolean).sort();

  return { rows, routes, raw };
}

/* ========= Filtros, KPIs y Tabs ========= */
function fillRoutesSelector(routes){
  const sel = $('#routeSel');
  sel.innerHTML = '';
  routes.forEach(r=>{
    const o = document.createElement('option');
    o.value = r; o.textContent = r.replace('-',' ‚Üí ');
    sel.appendChild(o);
  });
  if(!routes.length){
    const o = document.createElement('option');
    o.value = ''; o.textContent = '‚Äî';
    sel.appendChild(o);
  }
}

function applyFilters(rows){
  const r = $('#routeSel').value;
  const d1 = $('#dateFrom').value || '0000-00-00';
  const d2 = $('#dateTo').value   || '9999-12-31';
  const onlyCarry = $('#prefCarry').checked;
  const max1 = $('#prefStops').checked;

  return rows.filter(x=>{
    if(r && x.route !== r) return false;
    if(x.date < d1 || x.date > d2) return false;
    if(onlyCarry && x.equip && !/carry/i.test(x.equip)) return false;
    if(max1 && x.stops!=null && +x.stops>1) return false;
    return true;
  });
}

function renderKPIs(rows){
  $('#kpiSnaps').textContent = rows.length;
  $('#kpiSnapsDetail').textContent = 'Registros (tras filtros)';

  if(!rows.length){
    $('#kpiBestTotal').textContent='‚Äî'; $('#kpiBestTotalDetail').textContent='‚Äî';
    $('#kpiBestAir').textContent='‚Äî';   $('#kpiBestAirDetail').textContent='‚Äî';
    $('#kpiAvg').textContent='‚Äî';       $('#kpiAvgDetail').textContent='‚Äî';
    $('#kpiTopProv').textContent='‚Äî';   $('#kpiTopProvDetail').textContent='‚Äî';
    return;
  }

  const bestAir = rows.reduce((m,x)=> (x.air!=null && x.air<m.air)?x:m, {air:Infinity});
  $('#kpiBestAir').textContent = fmtUSD(bestAir.air);
  $('#kpiBestAirDetail').textContent = `${bestAir.date} ¬∑ ${bestAir.time} ¬∑ ${bestAir.provider||'‚Äî'}`;

  const totals = rows.map(x=>{
    const t = terrestrialRule(x.route);
    return { ...x, terr:t.mode, terrCost:t.cost, total:(x.air??0)+t.cost }
  });
  const bestTotal = totals.reduce((m,x)=> (x.total<m.total)?x:m, {total:Infinity});
  $('#kpiBestTotal').textContent = fmtUSD(bestTotal.total);
  $('#kpiBestTotalDetail').textContent = `${bestTotal.date} ¬∑ ${bestTotal.time} ¬∑ ${bestTotal.provider||'‚Äî'} (+${bestTotal.terr} ${fmtUSD(bestTotal.terrCost)})`;

  const avg = d3.mean(rows.filter(x=>x.air!=null), d=>d.air);
  $('#kpiAvg').textContent = fmtUSD(avg||0);
  $('#kpiAvgDetail').textContent = 'Promedio a√©reo (filtros)';

  const byDay = d3.group(rows, d=>d.date);
  const winners = [];
  for (const [day,arr] of byDay){
    const min = arr.reduce((m,x)=> (x.air!=null && x.air<m.air)?x:m, {air:Infinity});
    if(min.provider) winners.push(min.provider);
  }
  const freq = d3.rollup(winners, v=>v.length, d=>d);
  let top='‚Äî', topn=0;
  for (const [k,v] of freq.entries()) if (v>topn){ top=k; topn=v; }
  $('#kpiTopProv').textContent = top==='‚Äî' ? '‚Äî' : top;
  $('#kpiTopProvDetail').textContent = top==='‚Äî' ? '‚Äî' : `${topn} veces como m√≠nimo diario`;
}

function renderTab1(rows){
  const tb = $('#tblBest tbody'); tb.innerHTML='';
  rows.forEach(x=>{
    const t = terrestrialRule(x.route);
    const total = (x.air??0) + (t.cost||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.date}</td>
      <td>${x.time||'‚Äî'}</td>
      <td>${fmtUSD(x.air)}</td>
      <td>${x.provider||'‚Äî'}</td>
      <td class="muted">${t.mode}</td>
      <td>${fmtUSD(t.cost)}</td>
      <td><b>${fmtUSD(total)}</b></td>
      <td><span class="pill">${x.equip||'‚Äî'}</span> <span class="pill">esc: ${x.stops??'‚Äî'}</span></td>
    `;
    tb.appendChild(tr);
  });
}

function renderTab2(rows){
  const byDay = d3.groups(rows, d=>d.date)
    .map(([date,arr])=>{
      const min = d3.min(arr.filter(x=>x.air!=null), d=>d.air);
      return {date, value: (min==null? null : min)};
    })
    .filter(d=>d.value!=null)
    .sort((a,b)=> a.date.localeCompare(b.date));

  $('#chartMeta').textContent = `${byDay.length} puntos (m√≠nimo a√©reo por d√≠a)`;

  const svg = d3.select('#chart'); svg.selectAll('*').remove();
  const W = svg.node().clientWidth || 900, H = svg.node().clientHeight || 260;
  const m = {t:20,r:20,b:30,l:48}, w=W-m.l-m.r, h=H-m.t-m.b;

  const g = svg.append('g').attr('transform',`translate(${m.l},${m.t})`);
  const x = d3.scaleBand().domain(byDay.map(d=>d.date)).range([0,w]).padding(0.2);
  const y = d3.scaleLinear().domain([0, d3.max(byDay,d=>d.value)||500]).nice().range([h,0]);

  g.append('g').attr('transform',`translate(0,${h})`)
    .call(d3.axisBottom(x).tickValues(x.domain().filter((_,i)=>!(i%Math.ceil(byDay.length/8)))) )
    .selectAll('text').attr('transform','translate(-10,10) rotate(-30)').style('font-size','11px').style('fill','#9fb3c8');

  g.append('g').call(d3.axisLeft(y).ticks(5))
    .selectAll('text').style('fill','#9fb3c8');

  g.selectAll('rect').data(byDay).enter().append('rect')
    .attr('x', d=>x(d.date)).attr('y', d=>y(d.value))
    .attr('width', x.bandwidth()).attr('height', d=>h - y(d.value))
    .attr('fill', '#2b5b86');
}

function renderTab3(rows){
  const tb = $('#tblFull tbody'); tb.innerHTML='';
  rows.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.date} ${x.time||''}</td>
      <td>${x.route}</td>
      <td>${fmtUSD(x.air)}</td>
      <td>${x.ok ? '<span class="status-ok">S√≠</span>' : '<span class="status-bad">No</span>'}</td>
      <td>${x.limit ?? '‚Äî'}</td>
      <td>${x.provider||'‚Äî'}</td>
      <td>${x.equip||'‚Äî'}</td>
      <td>${x.stops ?? '‚Äî'}</td>
    `;
    tb.appendChild(tr);
  });
}

function renderTab4(rawRows){
  const tb = $('#tblExplorer tbody'); tb.innerHTML='';
  rawRows.forEach(({ts, r})=>{
    const route = (r.route || r.ruta || '').replace(/\s+/g,'');
    const air   = r.best_offer?.total_usd ?? r.precio_encontrado ?? null;
    const ok    = r.best_offer?.under_budget ?? (typeof r.cumple==='string' ? r.cumple.includes('S√≠') : r.cumple);
    const limit = r.limite ?? null;
    const prov  = (r.providers?.meta?.[0]?.name || r.providers?.airlines?.[0]?.name || r.fuente || '‚Äî');
    const equip = (r.constraints?.carry_on_required ? 'carry-on' : (r.detalles?.equipaje || '‚Äî'));
    const stops = r.constraints?.max_stops ?? r.detalles?.escalas_max ?? '‚Äî';
    const origin = ('best_offer' in r) ? 'live' : ( 'precio_encontrado' in r ? 'mock' : 'unknown' );

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${ts}</td>
      <td>${route}</td>
      <td>${fmtUSD(air)}</td>
      <td>${ok===true ? 'S√≠' : (ok===false ? 'No' : '‚Äî')}</td>
      <td>${limit ?? '‚Äî'}</td>
      <td>${prov}</td>
      <td>${equip}</td>
      <td>${stops}</td>
      <td>${origin}</td>
    `;
    tb.appendChild(tr);
  });
}

/* ========= Orquestaci√≥n ========= */
let DATA = {rows:[], routes:[], raw:[]};

function applyFiltersWrapper(){
  const route = $('#routeSel').value;
  $('#routeBadge').textContent = route || '‚Äî';

  const rows = applyFilters(DATA.rows).filter(x=> x.route===route);
  rows.sort((a,b)=> a.ts.localeCompare(b.ts));

  renderKPIs(rows);
  renderTab1(rows);
  renderTab2(rows);
  renderTab3(rows);
  renderTab4(DATA.raw);
}

async function init(){
  const dataset = await loadDataset();
  DATA = dataset;
  fillRoutesSelector(DATA.routes);
  const pref = DATA.routes.find(r=>/LIM.*(MIA|FLL|MCO)/.test(r)) || DATA.routes[0] || '';
  $('#routeSel').value = pref;
  applyFiltersWrapper();
}

/* ========= Eventos ========= */
$$('#btnReload, #routeSel, #dateFrom, #dateTo, #prefCarry, #prefStops').forEach(el=>{
  el.addEventListener('change', applyFiltersWrapper);
  el.addEventListener('click',  applyFiltersWrapper);
});

$$('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    $('#viewT1').style.display = (t==='t1')?'block':'none';
    $('#viewT2').style.display = (t==='t2')?'block':'none';
    $('#viewT3').style.display = (t==='t3')?'block':'none';
    $('#viewT4').style.display = (t==='t4')?'block':'none';
  });
});

$('#btnCSV').addEventListener('click', ()=>{
  const headers = ["snapshot_ts","route","air_price","under_budget","limit","provider","equip","stops","origin_mode"];
  const lines = [headers.join(",")];
  DATA.raw.forEach(({ts, r})=>{
    const route = (r.route || r.ruta || '').replace(/\s+/g,'');
    const air   = r.best_offer?.total_usd ?? r.precio_encontrado ?? "";
    const ok    = r.best_offer?.under_budget ?? (typeof r.cumple==='string' ? r.cumple.includes('S√≠') : r.cumple);
    const limit = r.limite ?? "";
    const prov  = (r.providers?.meta?.[0]?.name || r.providers?.airlines?.[0]?.name || r.fuente || "");
    const equip = (r.constraints?.carry_on_required ? 'carry-on' : (r.detalles?.equipaje || ""));
    const stops = r.constraints?.max_stops ?? r.detalles?.escalas_max ?? "";
    const origin= ('best_offer' in r) ? 'live' : ( 'precio_encontrado' in r ? 'mock' : 'unknown' );

    lines.push([
      csvEscape(ts),
      csvEscape(route),
      csvEscape(air),
      csvEscape(ok),
      csvEscape(limit),
      csvEscape(prov),
      csvEscape(equip),
      csvEscape(stops),
      csvEscape(origin)
    ].join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "ultra_lowfare_full_export.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ========= Start ========= */
init();
</script>
</body>
</html>
