<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ultra-LowFare ¬∑ FrontWeb UX v1.4 (LIM‚ÜíMIA/MCO/FLL)</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101821; --card:#0f172a;
      --accent:#7cd4ff; --ok:#2bdc8c; --bad:#ff6b6b; --muted:#9aa4ad;
      --grid:#142036; --ink:#e6eef6; --ink2:#c7d0da; --brand:#0ea5e9;
      --link:#93c5fd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--ink);background:var(--bg)}
    header{display:flex;gap:14px;align-items:center;padding:14px 18px;border-bottom:1px solid #15253d;background:linear-gradient(180deg,#0b1220,#0b1220 70%,#0b0f14)}
    header h1{margin:0;font-size:18px}
    .badge{padding:4px 10px;border:1px solid #2a3a56;border-radius:999px;background:#0b1324;color:var(--ink2)}
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:calc(100% - 60px)}
    aside{background:var(--panel);border-right:1px solid #1a2b45;padding:16px 14px}
    aside h3{margin:0 0 8px;font-size:13px;color:var(--ink2);font-weight:600;letter-spacing:.2px}
    aside .block{background:var(--card);border:1px solid #1a2b45;border-radius:12px;padding:10px;margin-bottom:12px}
    select,input[type="date"],input[type="checkbox"]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #223556;background:#0a1322;color:var(--ink)}
    .main{display:grid;grid-template-rows:160px 1fr;gap:14px;padding:16px}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    .card{background:var(--panel);border:1px solid #1a2b45;border-radius:16px;padding:14px}
    .kpi-value{font-size:28px;font-weight:700;margin-top:6px}
    .tabs{display:flex;gap:6px}
    .tabs button{padding:8px 12px;border:1px solid #1f3050;background:#0b1528;color:var(--ink);border-radius:10px;cursor:pointer}
    .tabs button.active{background:var(--brand);border-color:var(--brand);color:#06111c}
    .pane{display:none}
    .pane.active{display:block}
    .grid-panel{background:var(--panel);border:1px solid #1a2b45;border-radius:16px;padding:0}
    .grid-panel header{position:static;background:#0f192e;border-radius:16px 16px 0 0;padding:12px 14px;border-bottom:1px solid #1a2b45}
    .table-wrap{overflow:auto;border-top:1px solid #1a2b45}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #172742;white-space:nowrap}
    th{background:#0f1924;position:sticky;top:0;color:var(--ink2);text-align:left}
    tr:hover{background:#0c1a31}
    a{color:var(--link);text-decoration:none}
    .ok{color:var(--ok)} .warn{color:#fbbf24} .bad{color:var(--bad)}
    .hint{color:var(--muted);font-size:12px}
    .mini{font-size:12px;color:var(--ink2)}
    .pill{border:1px solid #28466b;border-radius:999px;padding:2px 8px;background:#0c1629;color:var(--ink2);font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .chart{height:360px}
  </style>
</head>
<body>
  <header>
    <h1>Ultra-LowFare ¬∑ FrontWeb UX v1.4</h1>
    <span class="badge">Dataset: data.json + hist√≥rico.json</span>
    <span class="badge">Rutas: LIM‚ÜíMIA/FLL/MCO</span>
    <span class="badge">Ground rules: Tren MIA/FLL, Auto MCO</span>
    <span class="right hint">Actualiza datos con el bot√≥n en la barra lateral.</span>
  </header>

  <div class="layout">
    <aside>
      <div class="block">
        <h3>Rutas</h3>
        <select id="routeSel">
          <option value="LIM-MIA">LIM ‚Üí MIA</option>
          <option value="LIM-FLL">LIM ‚Üí FLL</option>
          <option value="LIM-MCO">LIM ‚Üí MCO</option>
        </select>
      </div>
      <div class="block">
        <h3>Rango de fechas (hist√≥rico)</h3>
        <label class="mini">Desde</label>
        <input type="date" id="fromDate">
        <label class="mini" style="margin-top:8px;display:block">Hasta</label>
        <input type="date" id="toDate">
      </div>
      <div class="block">
        <h3>Preferencias</h3>
        <label class="flex"><input type="checkbox" id="carryOnly" checked> Solo carry-on</label>
        <label class="flex"><input type="checkbox" id="max1stop" checked> M√°x 1 escala</label>
      </div>
      <div class="block">
        <button id="refreshBtn" style="width:100%;padding:10px;border-radius:10px;border:1px solid #2a4266;background:#0e1c33;color:#e8f0f8;cursor:pointer">
          üîÑ Actualizar datos
        </button>
        <div id="lastLoad" class="hint" style="margin-top:8px"></div>
      </div>
      <div class="block">
        <h3>Notas</h3>
        <div class="hint">
          ‚Ä¢ Mejor opci√≥n = <b>precio a√©reo m√°s bajo</b> + <b>terrestre</b> aplicable.<br>
          ‚Ä¢ LIM‚ÜíMCO fuerza <b>alquiler de auto</b> (regla del negocio).<br>
          ‚Ä¢ MIA/FLL intenta tren; si no hay, cae a auto.
        </div>
      </div>
    </aside>

    <div class="main">
      <div class="kpis">
        <div class="card">
          <div class="mini">Mejor total (a√©reo+terrestre)</div>
          <div id="kpiBestTotal" class="kpi-value">‚Äî</div>
          <div id="kpiBestBreak" class="mini hint">‚Äî</div>
        </div>
        <div class="card">
          <div class="mini">Mejor a√©reo</div>
          <div id="kpiBestAir" class="kpi-value">‚Äî</div>
          <div id="kpiBestAirMeta" class="mini hint">‚Äî</div>
        </div>
        <div class="card">
          <div class="mini">Promedio hist√≥rico</div>
          <div id="kpiAvg" class="kpi-value">‚Äî</div>
          <div class="mini hint">Ruta/criterios aplicados</div>
        </div>
        <div class="card">
          <div class="mini">Snapshots analizados</div>
          <div id="kpiSnaps" class="kpi-value">‚Äî</div>
          <div class="mini hint">Ventana temporal seleccionada</div>
        </div>
        <div class="card">
          <div class="mini">Proveedor top (frecuencia)</div>
          <div id="kpiTopProv" class="kpi-value">‚Äî</div>
          <div class="mini hint">M√°s veces ‚Äúmejor precio‚Äù</div>
        </div>
      </div>

      <div class="card">
        <div class="tabs" id="tabs">
          <button data-tab="pane1" class="active">1) Mejor opci√≥n por d√≠a/hora</button>
          <button data-tab="pane2">2) Hist√≥rico m√≠nimo por d√≠a/hora</button>
          <button data-tab="pane3">3) Detalle completo por d√≠a/hora</button>
        </div>

        <div id="pane1" class="pane active">
          <div class="grid-panel">
            <header class="flex">
              <b>Mejor opci√≥n consolidada (con terrestre)</b>
              <span class="pill" id="pane1Route">‚Äî</span>
            </header>
            <div class="table-wrap">
              <table id="tblBest">
                <thead>
                <tr>
                  <th>Fecha salida</th>
                  <th>Hora salida</th>
                  <th>A√©reo (USD)</th>
                  <th>Proveedor</th>
                  <th>Terrestre</th>
                  <th>Costo terrestre (USD)</th>
                  <th><b>Total</b> (USD)</th>
                  <th>Detalle</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="pane2" class="pane">
          <div class="grid-panel">
            <header class="flex">
              <b>Evoluci√≥n del mejor precio (a√©reo solo)</b>
              <span class="pill" id="pane2Route">‚Äî</span>
            </header>
            <div id="chartLine" class="chart"></div>
          </div>
        </div>

        <div id="pane3" class="pane">
          <div class="grid-panel">
            <header class="flex">
              <b>Detalle completo de capturas</b>
              <span class="pill" id="pane3Route">‚Äî</span>
            </header>
            <div class="table-wrap">
              <table id="tblAll">
                <thead>
                <tr>
                  <th>Fecha captura</th>
                  <th>Ruta</th>
                  <th>Proveedor</th>
                  <th>Tipo</th>
                  <th>Precio (USD)</th>
                  <th>Link</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ===========================
   0) Par√°metros del negocio
   =========================== */

// Costos base de tren por aeropuerto de llegada (placeholder ajustable).
const GROUND_COSTS = {
  MIA: { mode: "train", label: "Tri-Rail/Metrorail", cost: 7 },   // ejemplo
  FLL: { mode: "train", label: "Tri-Rail Shuttle",  cost: 8 },
  // Si se quisiera permitir tren a MCO, cambiar√≠a aqu√≠; por regla, usamos auto.
};

// Modelo de alquiler de auto (placeholder simple).
const RENTAL_MODEL = {
  basePerDay: 28,     // tarifa base/d√≠a (USD)
  taxesPct:   0.22,   // % aprox de impuestos/fees
  minDays:    1
};

// Lee JSONs generados por el bot
const PATH_DATA  = "./data/data.json";
const PATH_HIST  = "./data/historico.json";

// Rutas v√°lidas
const ROUTES = ["LIM-MIA","LIM-FLL","LIM-MCO"];

/* ===========================
   1) Utilidades
   =========================== */

const $ = sel => document.querySelector(sel);
function fmtUSD(v){ return v==null ? "‚Äî" : `$${v.toFixed(0)}`; }
function sameRouteTag(r){ return (r.route || r.ruta || "").replace("‚Üí","-").replace(/\s/g,''); }

function parseISO(s){
  const d = new Date(s);
  return isNaN(d) ? null : d;
}

// Estima d√≠as de alquiler entre dos ISO strings (si falta return, 3 d√≠as)
function estimateRentalDays(depISO, retISO){
  const d1 = parseISO(depISO);
  const d2 = parseISO(retISO);
  if (!d1 || !d2){ return 3; }
  const ms = Math.max(24*3600*1000, d2 - d1);
  return Math.ceil(ms / (24*3600*1000));
}

function rentalCost(days){
  const base = RENTAL_MODEL.basePerDay * Math.max(RENTAL_MODEL.minDays, days);
  return base * (1 + RENTAL_MODEL.taxesPct);
}

function groundFor(arrivalIata, depISO, retISO){
  if (arrivalIata === "MCO"){
    const days = estimateRentalDays(depISO, retISO);
    return { mode:"car", label:"Alquiler auto", cost: rentalCost(days) };
  }
  // Preferir tren si existe costo predefinido
  const meta = GROUND_COSTS[arrivalIata];
  if (meta){
    return { mode:"train", label: meta.label, cost: meta.cost };
  }
  // Fallback auto
  const days = estimateRentalDays(depISO, retISO);
  return { mode:"car", label:"Alquiler auto (fallback)", cost: rentalCost(days) };
}

// Extrae mejor precio a√©reo por snapshot para una ruta
function bestAirFromSnapshot(snapshot, routeTag){
  const arr = (snapshot.resultados || snapshot.resultado || []);
  const items = [];
  for (const r of arr){
    const tag = sameRouteTag({route: r.route || r.ruta});
    if (tag !== routeTag) continue;

    // Soporta diferentes esquemas (v1.3.x)
    if (r.best_offer?.total_usd){
      items.push({ price: r.best_offer.total_usd, provider: (r.providers?.meta?.[0]?.name || r.providers?.airlines?.[0]?.name || "‚Äî"), dep: r.dep, ret: r.ret });
    } else if (r.precio_encontrado){ // mock antiguo
      items.push({ price: r.precio_encontrado, provider: r.fuente || "‚Äî", dep: r.dep, ret: r.ret });
    }
  }
  if (!items.length) return null;
  items.sort((a,b)=>a.price-b.price);
  return items[0]; // m√≠nimo
}

/* ===========================
   2) Carga de datos
   =========================== */

async function loadAll(){
  const [snap, hist] = await Promise.all([
    fetch(PATH_DATA).then(r=>r.json()).catch(()=>null),
    fetch(PATH_HIST).then(r=>r.json()).catch(()=>[])
  ]);
  // historico.json siempre array
  const histArr = Array.isArray(hist) ? hist : (hist?.resultados ? [hist] : []);
  return { snap, hist: histArr };
}

/* ===========================
   3) Render KPIs + Pesta√±as
   =========================== */

function computeKPIs(routeTag, hist, filters){
  // Filtrar por fechas si se setean
  const fd = $("#fromDate").value ? new Date($("#fromDate").value) : null;
  const td = $("#toDate").value ? new Date($("#toDate").value) : null;

  const points = [];
  for (const s of hist){
    const ts = parseISO(s?.meta?.generado) || parseISO(s?.meta?.timestamp) || parseISO(s?.fecha);
    if (fd && ts && ts < fd) continue;
    if (td && ts && ts > td) continue;

    const best = bestAirFromSnapshot(s, routeTag);
    if (!best) continue;

    // Costo terrestre seg√∫n aeropuerto destino (segunda parte del tag)
    const dest = routeTag.split("-")[1];
    const ground = groundFor(dest, best.dep, best.ret);

    points.push({
      when: ts || new Date(),
      air: best.price,
      provider: best.provider,
      ground: ground.cost,
      total: best.price + ground.cost
    });
  }
  if (!points.length) return { points:[], avg:null, best:null, freq:null };

  // KPI promedio (a√©reo)
  const avg = d3.mean(points, d=>d.air);
  // Mejor total
  points.sort((a,b)=>a.total-b.total);
  const best = points[0];

  // proveedor m√°s frecuente como ‚Äúmejor a√©reo‚Äù (recalcular sobre m√≠nimos por snapshot)
  const byProv = d3.rollup(points, v=>v.length, d=>d.provider);
  const top = Array.from(byProv.entries()).sort((a,b)=>b[1]-a[1])[0];

  return { points, avg, best, freq: top };
}

function renderKPIs(k){
  $("#kpiBestTotal").textContent = k.best ? fmtUSD(k.best.total) : "‚Äî";
  $("#kpiBestBreak").textContent = k.best ? `A√©reo ${fmtUSD(k.best.air)} + Terrestre ${fmtUSD(k.best.ground)}` : "‚Äî";
  $("#kpiBestAir").textContent = k.best ? fmtUSD(k.best.air) : "‚Äî";
  $("#kpiBestAirMeta").textContent = k.best ? `Proveedor: ${k.best.provider}` : "‚Äî";
  $("#kpiAvg").textContent = k.avg ? fmtUSD(k.avg) : "‚Äî";
  $("#kpiSnaps").textContent = k.points?.length || 0;
  $("#kpiTopProv").textContent = k.freq ? `${k.freq[0]} (${k.freq[1]})` : "‚Äî";
}

function renderPane1(routeTag, k){
  $("#pane1Route").textContent = routeTag.replace("-"," ‚Üí ");
  const tb = $("#tblBest tbody");
  tb.innerHTML = "";

  // Tomamos los mejores por fecha/hora (con total)
  // Agrupar por d√≠a/hora de salida (si hay dep ISO)
  const grouped = d3.rollups(
    k.points,
    v => v.sort((a,b)=>a.total-b.total)[0],
    d => (d.when ? d.when.toISOString().slice(0,13)+":00" : "snapshot")
  ).map(([slot, best]) => ({ slot, best }));

  grouped.sort((a,b)=>a.slot.localeCompare(b.slot));

  for (const row of grouped){
    const depISO = row.best.when?.toISOString?.() ?? row.slot;
    const dt = new Date(depISO);
    const dateStr = isNaN(dt) ? row.slot : dt.toLocaleDateString();
    const timeStr = isNaN(dt) ? "‚Äî" : dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>${timeStr}</td>
      <td>${fmtUSD(row.best.air)}</td>
      <td>${row.best.provider}</td>
      <td>${row.best.ground ? (row.best.ground>30 ? "Auto" : "Tren") : "‚Äî"}</td>
      <td>${fmtUSD(row.best.ground)}</td>
      <td><b>${fmtUSD(row.best.total)}</b></td>
      <td class="hint">Consolidado por slot</td>
    `;
    tb.appendChild(tr);
  }
}

function renderPane2(routeTag, k){
  $("#pane2Route").textContent = routeTag.replace("-"," ‚Üí ");
  const el = d3.select("#chartLine");
  el.selectAll("*").remove();

  const data = k.points.slice().sort((a,b)=>a.when-b.when);
  if (!data.length){
    el.append("div").attr("class","hint").style("padding","16px").text("Sin datos hist√≥ricos para la selecci√≥n.");
    return;
  }

  const W = el.node().clientWidth, H = el.node().clientHeight, m={t:18,r:18,b:26,l:46};
  const iw = W - m.l - m.r, ih = H - m.t - m.b;

  const svg = el.append("svg").attr("width",W).attr("height",H);
  const g = svg.append("g").attr("transform",`translate(${m.l},${m.t})`);

  const x = d3.scaleTime().domain(d3.extent(data,d=>d.when)).range([0,iw]);
  const y = d3.scaleLinear().domain([0, d3.max(data,d=>d.air)*1.1]).nice().range([ih,0]);

  // eje
  g.append("g").attr("transform",`translate(0,${ih})`).call(d3.axisBottom(x).ticks(6));
  g.append("g").call(d3.axisLeft(y).ticks(6));

  // l√≠nea
  const line = d3.line().x(d=>x(d.when)).y(d=>y(d.air));
  g.append("path").datum(data).attr("d",line).attr("fill","none").attr("stroke","#7cd4ff").attr("stroke-width",2);

  // puntos
  g.selectAll("circle").data(data).enter().append("circle")
    .attr("cx",d=>x(d.when)).attr("cy",d=>y(d.air)).attr("r",3).attr("fill","#93c5fd");
}

function renderPane3(routeTag, hist){
  $("#pane3Route").textContent = routeTag.replace("-"," ‚Üí ");
  const tb = $("#tblAll tbody"); tb.innerHTML = "";

  const rows = [];
  for (const s of hist){
    const ts = parseISO(s?.meta?.generado) || parseISO(s?.meta?.timestamp) || new Date();
    const arr = s.resultados || s.resultado || [];
    for (const r of arr){
      const tag = sameRouteTag({route: r.route || r.ruta});
      if (tag !== routeTag) continue;

      // Intentar ‚Äúproveedores‚Äù (v1.3.x) o ‚Äúfuente‚Äù
      const providers = (r.providers?.meta || []).concat(r.providers?.airlines || []);
      if (providers.length && r.best_offer?.total_usd){
        const p = providers[0];
        rows.push({
          when: ts, route: tag.replace("-", " ‚Üí "),
          provider: p.name || p.id || "‚Äî",
          kind: (p.id && p.id.includes("air")) ? "airline" : "meta",
          price: r.best_offer.total_usd,
          link: p.link || "#"
        });
      } else if (r.precio_encontrado){
        rows.push({
          when: ts, route: tag.replace("-", " ‚Üí "),
          provider: r.fuente || "‚Äî",
          kind: "mixed",
          price: r.precio_encontrado,
          link: "#"
        });
      }
    }
  }

  rows.sort((a,b)=>b.when - a.when);

  for (const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.when.toLocaleString()}</td>
      <td>${r.route}</td>
      <td>${r.provider}</td>
      <td>${r.kind}</td>
      <td>${fmtUSD(r.price)}</td>
      <td>${r.link && r.link!=="#" ? `<a href="${r.link}" target="_blank">abrir</a>` : "‚Äî"}</td>
    `;
    tb.appendChild(tr);
  }
}

/* ===========================
   4) Orquestaci√≥n
   =========================== */

let STATE = {snap:null, hist:[], route:"LIM-MIA"};

async function refresh(){
  $("#lastLoad").textContent = "Cargando‚Ä¶";
  const data = await loadAll();
  STATE.snap = data.snap;
  STATE.hist = data.hist;
  $("#lastLoad").textContent = "Datos cargados: " + (new Date()).toLocaleString();

  const routeTag = $("#routeSel").value;
  const k = computeKPIs(routeTag, STATE.hist, {});
  renderKPIs(k);
  renderPane1(routeTag, k);
  renderPane2(routeTag, k);
  renderPane3(routeTag, STATE.hist);
}

// Tabs
document.querySelectorAll("#tabs button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("#tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    document.querySelectorAll(".pane").forEach(p=>p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  });
});

// Eventos UI
$("#routeSel").addEventListener("change", refresh);
$("#fromDate").addEventListener("change", refresh);
$("#toDate").addEventListener("change", refresh);
$("#refreshBtn").addEventListener("click", refresh);

// Kickoff
refresh();
</script>
</body>
</html>
