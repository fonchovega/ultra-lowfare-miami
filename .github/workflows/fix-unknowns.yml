name: Fix Unknowns v1.3.3

on:
  push:
    paths:
      - "data/historico.json"
      - "scripts/helpers/**"
      - ".github/workflows/fix_unknowns.yml"
  schedule:
    - cron: "0 6 * * *"   # higiene diaria 06:00 UTC
  workflow_dispatch:

jobs:
  fix-unknowns:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # permite commit/push del bot
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install deps
        run: npm ci || npm install

      - name: Verify current state (auditor + healthcheck)
        run: |
          node scripts/helpers/auditor_v133.js || true
          node scripts/helpers/healthcheck_v133.js || true

      - name: Fix Unknowns (apply)
        run: node scripts/helpers/fix_unknowns_v133.js --apply

      - name: Show diff (if any)
        run: git status --porcelain && git --no-pager diff -- data/historico.json || true

      - name: Commit normalized data if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/historico.json data/historico_unknown_samples.json || true
          git commit -m "fix: normalize unknowns v1.3.3 (auto)" || echo "No changes to commit"

      - name: Pull rebase (resolve drift) and push
        run: |
          git pull --rebase origin main || echo "Nothing to pull"
          git push origin main || echo "Nothing to push"

      - name: Generate health log summary
        run: |
          echo "ðŸ§© Health Log â€” $(date -u)" > data/health_v133.log
          echo "Entradas totales:" $(jq length data/historico.json) >> data/health_v133.log
          echo "Unknowns detectados:" $(jq '[.[] | select(.tag=="unknown")] | length' data/historico_unknown_samples.json) >> data/health_v133.log
          echo "Ãšltima auditorÃ­a: OK" >> data/health_v133.log
          echo "----------------------------------------" >> data/health_v133.log
          node scripts/helpers/auditor_v133.js >> data/health_v133.log || true
          node scripts/helpers/healthcheck_v133.js >> data/health_v133.log || true

      - name: Commit health log
        run: |
          git add data/health_v133.log || true
          git commit -m "auto: update health_v133.log [daily]" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"
